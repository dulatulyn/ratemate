name: CI/CD
on:
  push:
    branches: [prod]
  workflow_dispatch:

env:
  APP_NAME: ratemate

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build image
        run: docker build -t ${{ env.APP_NAME }}:latest .
      - name: Save image
        run: | 
          docker save ${{ env.APP_NAME }}:latest | gzip > ${{ env.APP_NAME }}.tar.gz
      - uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: ${{ env.APP_NAME}}.tar.gz
          retention-days: 1
  
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with: 
          name: docker-image
          path: .
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass
      - name: Copy to VM
        run: |
          sshpass -p "${{ secrets.VM_PASSWORD }}" scp -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no -P 22 "${{ env.APP_NAME }}.tar.gz" "${{ secrets.VM_USERNAME}}@${{ secrets.VM_HOST}}:/tmp/${{ env.APP_NAME }}.tar.gz"
      - name: Deploy on VM
        run: | 
          sshpass -p "${{ secrets.VM_PASSWORD }}" ssh -tt -o StrictHostKeyChecking=no -o StrictHostKeyChecking=no -o
          PreferredAuthentications=password -o PublicAuthentication=no -p 22 \ ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} << 'EOF'
          set -e
          gunzip -c /tmp/${{ env.APP_NAME }}.tar.gz | sudo docker load
          sudo mkdir -p /opt/ratemate && cd /opt/ratemate
          cat <<EENV | sudo tee .env >/dev/null
          DATABASE_URL=postgresql+asyncpg://postgres:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/ratemate
          DATABASE_ECHO=False
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          JWT_ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=60
          ENVIRONMENT=production
          DEBUG=False
          AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
          AZURE_STORAGE_CONTAINER=${{ secrets.AZURE_STORAGE_CONTAINER }}
          ADMIN_PANEL_KEY=${{ secrets.ADMIN_PANEL_KEY }}
          ADMIN_BASIC_USERNAME=${{ secrets.ADMIN_BASIC_USERNAME }}
          ADMIN_BASIC_PASSWORD=${{ secrets.ADMIN_BASIC_PASSWORD }}
          EENV
          sudo docker run -d --name postgres --restart unless-stopped \
            -e POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
            -e POSTGRES_DB=ratemate \
            -p 5432:5432 \
            -v postgres_data:/var/lib/postgresql/data \
            postgres:16-alpine
          sudo docker run -d --name ratemate --restart unless-stopped \
            --link postgres:postgres \
            -p 8080:8080 \
            --env-file .env \
            ratemate:latest
          cat << 'NG' | sudo tee /tmp/nginx.conf >/dev/null 
          server{ listen 80;
            location / {
              proxy_pass http://ratemate:8080;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
            }
          }
          NG
          sudo docker run -d --name nginx --restart unless-stopped -p 80:80 \
            -v /tmp/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
            --link ratemate:ratemate \
            nginx:alpine 
          EOF

